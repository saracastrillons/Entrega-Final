<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mi panel - LibrosAPI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="index.html">LibrosAPI</a>
    <div>
      <button id="logout" class="btn btn-outline-light">Salir</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <h1 class="mb-4">Mis libros</h1>

  <form id="formCrear" class="row g-2 mb-4">
    <div class="col-md-3"><input class="form-control" id="nombre" placeholder="Título" required></div>
    <div class="col-md-3"><input class="form-control" id="autor" placeholder="Autor" required></div>
    <div class="col-md-2"><input class="form-control" id="anio" placeholder="Año publicación"></div>
    <div class="col-md-2">
      <select class="form-select" id="cond">
        <option value="nuevo">nuevo</option>
        <option value="como_nuevo">como_nuevo</option>
        <option value="bueno" selected>bueno</option>
        <option value="aceptable">aceptable</option>
        <option value="deteriorado">deteriorado</option>
      </select>
    </div>
    <div class="col-md-2 d-grid"><button class="btn btn-primary" type="submit">Agregar</button></div>
  </form>

  <table class="table table-striped">
    <thead><tr><th>Título</th><th>Autor</th><th>Año</th><th>Condición</th><th>Acciones</th></tr></thead>
    <tbody id="tbody"></tbody>
  </table>

  <hr class="my-4">

  <h2>Publicar en catálogo</h2>
  <form id="formPublicar" class="row g-2">
    <div class="col-md-3"><input class="form-control" id="pubLibro" placeholder="ID del libro" required></div>
    <div class="col-md-3"><input class="form-control" id="precio" placeholder="Precio (vacío = solo visible)"></div>
    <div class="col-md-3 d-grid"><button class="btn btn-success" type="submit">Publicar</button></div>
  </form>

  <div id="msg" class="mt-3"></div>
</div>

<script>
function token(){ return localStorage.getItem('token') || ''; }
function authHeaders(){ return { 'Content-Type':'application/json', 'Authorization':'Bearer '+token() }; }

document.getElementById('logout').onclick = ()=>{ localStorage.removeItem('token'); location.href='login.html'; };

async function cargarMisLibros(){
  const r = await fetch('/api/libros/mios', { headers: authHeaders() });
  if(r.status===401){ location.href='login.html'; return; }
  const data = await r.json();
  const tb = document.getElementById('tbody');
  tb.innerHTML = '';
  data.forEach(l => {
    tb.innerHTML += `
      <tr>
        <td><input class="form-control form-control-sm" value="${l.nombre_Libro}" id="n${l.id_Libro}"></td>
        <td><input class="form-control form-control-sm" value="${l.autor}" id="a${l.id_Libro}"></td>
        <td><input class="form-control form-control-sm" value="${l.publicacion||''}" id="p${l.id_Libro}"></td>
        <td>
          <select class="form-select form-select-sm" id="c${l.id_Libro}">
            ${['nuevo','como_nuevo','bueno','aceptable','deteriorado'].map(v=>`<option value="${v}" ${v===l.condicion?'selected':''}>${v}</option>`).join('')}
          </select>
        </td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-outline-primary me-2" onclick="guardar(${l.id_Libro})">Guardar</button>
          <button class="btn btn-sm btn-outline-danger" onclick="borrar(${l.id_Libro})">Borrar</button>
        </td>
      </tr>`;
  });
}

async function guardar(id){
  const body = {
    nombre_Libro: document.getElementById('n'+id).value,
    autor: document.getElementById('a'+id).value,
    publicacion: document.getElementById('p'+id).value || null,
    condicion: document.getElementById('c'+id).value
  };
  const r = await fetch('/api/libros/'+id, { method:'PUT', headers: authHeaders(), body: JSON.stringify(body) });
  document.getElementById('msg').innerHTML = r.ok ? '<div class="alert alert-success">Actualizado</div>' : '<div class="alert alert-danger">Error</div>';
  cargarMisLibros();
}

async function borrar(id){
  const r = await fetch('/api/libros/'+id, { method:'DELETE', headers: authHeaders() });
  document.getElementById('msg').innerHTML = r.ok ? '<div class="alert alert-warning">Eliminado</div>' : '<div class="alert alert-danger">No se pudo eliminar</div>';
  cargarMisLibros();
}

document.getElementById('formCrear').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const body = {
    nombre_Libro: document.getElementById('nombre').value,
    autor: document.getElementById('autor').value,
    publicacion: document.getElementById('anio').value || null,
    condicion: document.getElementById('cond').value
  };
  const r = await fetch('/api/libros', { method:'POST', headers: authHeaders(), body: JSON.stringify(body) });
  document.getElementById('msg').innerHTML = r.ok ? '<div class="alert alert-success">Creado</div>' : '<div class="alert alert-danger">Error al crear</div>';
  e.target.reset();
  cargarMisLibros();
});

document.getElementById('formPublicar').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id_Libro = Number(document.getElementById('pubLibro').value);
  const precioVal = document.getElementById('precio').value;
  const body = { id_Libro, precio: precioVal===''? null : Number(precioVal) };
  const r = await fetch('/api/catalogo/publicar', { method:'POST', headers: authHeaders(), body: JSON.stringify(body) });
  const data = await r.json();
  document.getElementById('msg').innerHTML = r.ok ? '<div class="alert alert-info">Publicado (id '+data.id_Publicacion+')</div>' : '<div class="alert alert-danger">Error: '+(data.error||'')+'</div>';
});

cargarMisLibros();
</script>
</body>
</html>
